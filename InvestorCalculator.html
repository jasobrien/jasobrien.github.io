    <!-- ...existing code... -->
    <!-- ...existing main content... -->
<!-- ...existing main content... -->

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Property Investment Calculator ‚Äî NSW (with Tax Module)</title>

<!-- Fonts & libraries -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

<style>
  :root{ 
    --bg:#f4f7fb; 
    --card:#ffffff; 
    --accent:#1c7ed6; 
    --accent-hover:#1565c0;
    --muted:#5f7a86; 
    --panel:#f6fbff;
    --success:#10b981;
    --danger:#ef4444;
    --warning:#f59e0b;
    --border:#e2edf2;
    --shadow: 0 8px 28px rgba(8,29,40,.06);
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{
    font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    background:linear-gradient(180deg,#f7fafc 0%,var(--bg) 100%);
    color:#12343b;
    padding:20px;
    line-height:1.6;
  }
  .app{max-width:1200px;margin:0 auto}
  
  /* Header */
  header{display:flex;align-items:center;gap:16px;margin-bottom:28px;padding-bottom:20px;border-bottom:2px solid var(--border)}
  header .brand{background:linear-gradient(135deg,var(--accent),#0b6aa0);color:white;padding:16px;border-radius:12px;box-shadow:0 4px 12px rgba(28,126,214,0.3)}
  header .brand strong{font-size:18px;display:block}
  header h1{margin:0;font-size:22px;font-weight:700;color:#0b3b4b} 
  header p{margin:4px 0 0 0;color:var(--muted);font-size:14px}
  
  /* Layout */
  .grid{display:grid;grid-template-columns:1fr 480px;gap:24px;align-items:start}
  .card{background:var(--card);border-radius:14px;padding:24px;box-shadow:var(--shadow);border:1px solid var(--border)}
  
  /* Section Headers */
  .section-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:12px 0;
    margin:20px 0 12px 0;
    border-bottom:2px solid var(--border);
    cursor:pointer;
    user-select:none;
  }
  .section-header h3{font-size:16px;font-weight:700;color:#0b3b4b;margin:0}
  .section-header .toggle{font-size:18px;color:var(--muted);transition:transform 0.2s}
  .section-header.collapsed .toggle{transform:rotate(-90deg)}
  .section-content{overflow:hidden;transition:max-height 0.3s ease-out}
  .section-content.collapsed{max-height:0 !important}
  
  /* Form Controls */
  label{display:block;font-weight:600;margin-top:14px;color:#13353a;font-size:13px}
  label.required::after{content:' *';color:var(--danger)}
  input[type="number"], select, input[type="text"]{
    width:100%;
    padding:11px 14px;
    border-radius:8px;
    border:2px solid var(--border);
    margin-top:6px;
    font-size:14px;
    transition:all 0.2s;
    background:white;
  }
  input[type="number"]:focus, select:focus{
    outline:none;
    border-color:var(--accent);
    box-shadow:0 0 0 3px rgba(28,126,214,0.1);
  }
  input[type="number"]:hover, select:hover{border-color:#cbd5e1}
  
  /* Checkbox Styling */
  .checkbox-wrapper{
    display:flex;
    align-items:center;
    gap:10px;
    margin-top:16px;
    padding:12px;
    background:var(--panel);
    border-radius:8px;
    border:1px solid var(--border);
  }
  .checkbox-wrapper input[type="checkbox"]{
    width:20px;
    height:20px;
    cursor:pointer;
    accent-color:var(--accent);
  }
  .checkbox-wrapper label{margin:0;font-weight:500;cursor:pointer;flex:1}
  
  .small{font-size:12px;color:var(--muted);margin-top:6px;line-height:1.4}
  .row{display:flex;gap:14px;margin-top:8px}
  .col{flex:1;min-width:0}
  
  /* Buttons */
  .controls{display:flex;gap:10px;margin-top:20px;flex-wrap:wrap}
  .btn{
    background:var(--accent);
    color:white;
    padding:12px 20px;
    border-radius:8px;
    border:none;
    cursor:pointer;
    font-weight:600;
    font-size:14px;
    transition:all 0.2s;
    box-shadow:0 2px 8px rgba(28,126,214,0.2);
  }
  .btn:hover{background:var(--accent-hover);transform:translateY(-1px);box-shadow:0 4px 12px rgba(28,126,214,0.3)}
  .btn:active{transform:translateY(0)}
  .btn.secondary{
    background:#eef6fb;
    color:var(--accent);
    border:2px solid var(--border);
    box-shadow:none;
  }
  .btn.secondary:hover{background:#e0f2fe;border-color:var(--accent)}
  
  /* Results Panel */
  .results-sticky{position:sticky;top:20px}
  .results .line{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:10px 0;
    border-bottom:1px dashed rgba(8,29,40,0.06);
  }
  .results .line:last-child{border-bottom:0}
  .results .line.highlight{background:var(--panel);padding:10px 12px;border-radius:6px;margin:4px -12px}
  .kpi{font-size:20px;font-weight:700;color:#0b3b4b}
  .kpi.positive{color:var(--success)}
  .kpi.negative{color:var(--danger)}
  .kpi.neutral{color:var(--muted)}
  
  /* Yield Badges */
  .yield-badges{
    display:flex;
    gap:12px;
    margin-top:12px;
    padding-top:12px;
    border-top:1px solid var(--border);
  }
  .badge{
    flex:1;
    padding:10px;
    background:var(--panel);
    border-radius:8px;
    text-align:center;
    border:1px solid var(--border);
  }
  .badge-label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px}
  .badge-value{font-size:18px;font-weight:700;color:var(--accent);margin-top:4px}
  
  /* Charts */
  .chart-wrap{
    padding:16px;
    background:var(--panel);
    border-radius:10px;
    margin-top:16px;
    border:1px solid var(--border);
  }
  .chart-title{font-size:14px;font-weight:600;margin-bottom:12px;color:#0b3b4b}
  canvas{width:100% !important;height:280px !important}
  
  /* Info/Analysis Box */
  .info-box{
    margin-top:24px;
    padding:16px;
    background:linear-gradient(135deg,#f0f9ff 0%,#e0f2fe 100%);
    border-radius:10px;
    border-left:4px solid var(--accent);
  }
  .info-box strong{color:var(--accent);display:block;margin-bottom:6px;font-size:14px}
  .info-box-content{color:#1e40af;font-size:14px;line-height:1.6}
  
  /* Footer/Disclaimer */
  footer{
    margin-top:20px;
    color:var(--muted);
    font-size:12px;
    padding:12px;
    background:rgba(95,122,134,0.05);
    border-radius:8px;
    line-height:1.6;
  }
  footer.warning{
    background:rgba(239,68,68,0.1);
    border-left:3px solid var(--danger);
  }
  
  /* Mobile Responsive */
  @media(max-width:1024px){
    .grid{grid-template-columns:1fr}
    .results-sticky{position:static}
    body{padding:16px}
    .card{padding:20px}
    header{flex-direction:column;align-items:flex-start}
  }
  @media(max-width:640px){
    .row{flex-direction:column;gap:8px}
    .controls{flex-direction:column}
    .btn{width:100%;text-align:center}
    .yield-badges{flex-direction:column}
  }
</style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand"><strong style="font-size:16px">PropCalc</strong></div>
      <div>
        <h1>Property Investment Calculator ‚Äî NSW</h1>
        <p>Includes negative gearing + depreciation module and PDF export</p>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: Inputs -->
      <div class="card">
        <h3 style="margin:0 0 16px 0;font-size:18px;color:#0b3b4b">Investment Details</h3>

        <!-- Core Property Details -->
        <div class="section-header" data-section="property">
          <h3>üè† Property Details</h3>
          <span class="toggle">‚ñº</span>
        </div>
        <div class="section-content" id="section-property">
          <div class="row">
            <div class="col">
              <label class="required">Purchase price (AUD)</label>
              <input id="price" type="number" value="500000" step="1000" placeholder="500,000" />
            </div>
            <div class="col">
              <label class="required">Weekly rent (AUD)</label>
              <input id="rent_week" type="number" value="500" placeholder="500" />
            </div>
          </div>

          <div class="row">
            <div class="col">
              <label>Strata fees (per quarter)</label>
              <input id="strata_qtr" type="number" value="1000" placeholder="1,000" />
              <div class="small">Set to 0 if no strata/body corporate</div>
            </div>
          </div>
        </div>

        <!-- Financing -->
        <div class="section-header" data-section="financing">
          <h3>üí∞ Financing</h3>
          <span class="toggle">‚ñº</span>
        </div>
        <div class="section-content" id="section-financing">
          <div class="row">
            <div class="col">
              <label class="required">Deposit (%)</label>
              <input id="deposit_percent" type="number" value="20" min="5" max="80" />
              <div class="small">Minimum 5%, typically 20% to avoid LMI</div>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <label class="required">Interest rate (annual %)</label>
              <input id="interest_rate" type="number" step="0.1" value="6.0" placeholder="6.0" />
              <div class="small">Current typical rate: 6.0% - 7.5%</div>
            </div>
            <div class="col">
              <label class="required">Loan term (years)</label>
              <input id="loan_term" type="number" value="30" min="1" max="50" placeholder="30" />
            </div>
          </div>

          <div class="checkbox-wrapper">
            <input id="include_lmi" type="checkbox" />
            <label for="include_lmi">Estimate LMI (Lenders Mortgage Insurance)</label>
          </div>
          <div class="small" style="margin-left:42px">Auto-enabled for deposits under 20%. This is a rough estimate only.</div>
        </div>


        <!-- Purchase Costs -->
        <div class="section-header" data-section="costs">
          <h3>üìã Purchase Costs</h3>
          <span class="toggle">‚ñº</span>
        </div>
        <div class="section-content" id="section-costs">
          <div class="row">
            <div class="col">
              <label>Conveyancing / legal fees</label>
              <input id="legal_fee" type="number" value="1500" placeholder="1,500" />
            </div>
            <div class="col">
              <label>Building & pest inspection</label>
              <input id="inspection_fee" type="number" value="400" placeholder="400" />
            </div>
          </div>

          <div class="row">
            <div class="col">
              <label>Loan application & valuation</label>
              <input id="loan_fees" type="number" value="600" placeholder="600" />
            </div>
          </div>
          <div class="small">Stamp duty is calculated automatically based on NSW rates</div>
        </div>


        <!-- Ongoing Expenses -->
        <div class="section-header" data-section="expenses">
          <h3>üîß Ongoing Expenses</h3>
          <span class="toggle">‚ñº</span>
        </div>
        <div class="section-content" id="section-expenses">
          <div class="row">
            <div class="col">
              <label>Property management fee (%)</label>
              <input id="pm_pct" type="number" value="7" placeholder="7" step="0.5" />
              <div class="small">Typical range: 5% - 10% of rental income</div>
            </div>
            <div class="col">
              <label>Annual maintenance budget</label>
              <input id="maintenance" type="number" value="1000" placeholder="1,000" />
              <div class="small">Recommended: 0.5% - 1% of property value</div>
            </div>
          </div>
          <div class="small">Council rates ($2,200/yr) and insurance ($400/yr) are included automatically</div>
        </div>

        <!-- Depreciation -->
        <div class="section-header" data-section="depreciation">
          <h3>üìâ Depreciation</h3>
          <span class="toggle">‚ñº</span>
        </div>
        <div class="section-content" id="section-depreciation">
          <div class="checkbox-wrapper">
            <input id="include_depreciation" type="checkbox" />
            <label for="include_depreciation">Include depreciation deductions (new builds only)</label>
          </div>
          <div class="small" style="margin-left:42px">Depreciation typically not available for older established properties</div>

          <div class="row" style="margin-top:12px">
            <div class="col">
              <label>Building value (Division 43)</label>
              <input id="building_value" type="number" value="150000" placeholder="150,000" />
              <div class="small">Structural: 2.5% annually over 40 years</div>
            </div>
            <div class="col">
              <label>Plant & equipment (Division 40)</label>
              <input id="div40_annual" type="number" value="2000" placeholder="2,000" />
              <div class="small">Annual claim for fixtures & fittings</div>
            </div>
          </div>
        </div>

        <!-- Tax & Income -->
        <div class="section-header" data-section="tax">
          <h3>üíµ Tax & Income</h3>
          <span class="toggle">‚ñº</span>
        </div>
        <div class="section-content" id="section-tax">
          <label>Your marginal tax rate</label>
          <select id="taxBracket">
            <option value="0.30">30% ‚Äî Taxable income $45,001 to $120,000</option>
            <option value="0.37">37% ‚Äî Taxable income $120,001 to $180,000</option>
            <option value="0.45">45% ‚Äî Taxable income $180,001+</option>
          </select>
          <div class="small">Includes Medicare Levy. Used to calculate negative gearing benefits.</div>
        </div>

        <!-- Action Buttons -->
        <div class="controls">
          <button class="btn" id="calcBtn">üîÑ Recalculate</button>
          <button class="btn secondary" id="pdfBtn">üìÑ Download PDF</button>
          <button class="btn secondary" id="resetBtn">‚Ü∫ Reset</button>
        </div>

        <!-- Analysis Box -->
        <div id="analysis" class="info-box">
          <strong>üí° Cashflow Analysis</strong>
          <div id="analysis_text" class="info-box-content">
            <!-- Will be filled by JS -->
          </div>
        </div>

        <!-- Disclaimers -->
        <footer class="small">Stamp duty calculated using NSW tiered bands for residential property transfers. Always confirm with Revenue NSW for precise duty calculations and available concessions.</footer>
        <footer class="small warning">
          <strong>‚ö†Ô∏è Disclaimer:</strong> This calculator is for informational and educational purposes only and does not constitute financial, investment, or tax advice. Results are estimates based on inputs provided. Please consult with a registered financial advisor, accountant, or tax professional before making any investment decisions.
        </footer>
      </div>

      <!-- RIGHT: Results + Chart -->
      <div class="card results-sticky">
        <h3 style="margin:0 0 20px 0;font-size:18px;color:#0b3b4b;border-bottom:2px solid var(--border);padding-bottom:12px">üìä Investment Summary</h3>
        
        <!-- Upfront Costs -->
        <h4 style="font-size:14px;color:var(--muted);margin:16px 0 8px 0;text-transform:uppercase;letter-spacing:0.5px">üíµ Upfront Costs</h4>
        <div id="results" class="results">
          <div class="line"><div>Deposit (cash required)</div><div class="kpi" id="out_deposit">$0</div></div>
          <div class="line"><div>Stamp duty (NSW)</div><div id="out_stamp">$0</div></div>
          <div class="line"><div>Purchase fees & LMI</div><div id="out_fees">$0</div></div>
          <div class="line highlight"><div><strong>üí∞ Total upfront capital</strong></div><div class="kpi" id="out_upfront">$0</div></div>
        </div>

        <!-- Loan Details -->
        <h4 style="font-size:14px;color:var(--muted);margin:20px 0 8px 0;text-transform:uppercase;letter-spacing:0.5px">üè¶ Loan Details</h4>
        <div class="results">
          <div class="line"><div>Loan amount</div><div id="out_loan">$0</div></div>
          <div class="line"><div>Monthly repayment (P&I)</div><div class="kpi" id="out_monthly">$0</div></div>
          <div class="line"><div>Annual interest (Year 1)</div><div id="out_interest">$0</div></div>
        </div>

        <!-- Annual Cashflow -->
        <h4 style="font-size:14px;color:var(--muted);margin:20px 0 8px 0;text-transform:uppercase;letter-spacing:0.5px">üìà Annual Cashflow</h4>
        <div class="results">
          <div class="line"><div>Rental income</div><div class="kpi positive" id="out_rent_annual">$0</div></div>
          <div class="line"><div>Operating expenses</div><div class="kpi negative" id="out_opcosts">$0</div></div>
          <div class="line"><div>Interest paid</div><div class="kpi negative" id="out_interest_display">$0</div></div>
          <div class="line highlight"><div><strong>üìä Net cashflow (before tax)</strong></div><div class="kpi" id="out_cashflow">$0</div></div>
        </div>

        <!-- Yield Badges -->
        <div class="yield-badges">
          <div class="badge">
            <div class="badge-label">Gross Yield</div>
            <div class="badge-value" id="out_gross_yield">-</div>
          </div>
          <div class="badge">
            <div class="badge-label">Net Yield</div>
            <div class="badge-value" id="out_net_yield">-</div>
          </div>
        </div>

        <!-- Chart -->
        <div class="chart-wrap">
          <div class="chart-title">Annual Income & Expenses Breakdown</div>
          <canvas id="cashflowChart" aria-label="Cashflow chart"></canvas>
        </div>

        <!-- Tax & Depreciation -->
        <div style="margin-top:20px;padding:16px;background:var(--panel);border-radius:10px;border:1px solid var(--border)">
          <h4 style="font-size:14px;color:#0b3b4b;margin:0 0 12px 0">üßæ Tax & Negative Gearing</h4>
          <div class="results">
            <div class="line"><div>Annual depreciation</div><div id="out_depreciation">$0</div></div>
            <div class="line"><div>Tax-deductible loss</div><div id="out_total_deduction">$0</div></div>
            <div class="line"><div>Tax refund estimate</div><div class="kpi positive" id="out_tax_refund">$0</div></div>
            <div class="line highlight"><div><strong>‚úÖ After-tax cashflow</strong></div><div class="kpi" id="out_after_tax_cashflow">$0</div></div>
          </div>
        </div>
      </div>
    </div>

  </div>

<script>
/* ===== NSW duty bands (illustrative) ===== */
const nswDutyTable = [
  {min: 0,      max: 16000,  base: 0,      ratePer100: 1.25},
  {min: 16000,  max: 35000,  base: 200,    ratePer100: 1.50},
  {min: 35000,  max: 93000,  base: 485,    ratePer100: 1.75},
  {min: 93000,  max: 351000, base: 1500,   ratePer100: 3.50},
  {min: 351000, max: 1168000, base:10530,  ratePer100: 4.50},
  {min: 1168000, max: Infinity, base:47295, ratePer100: 5.50}
];

function calcNSWDuty(price){
  price = Number(price) || 0;
  for(const row of nswDutyTable){
    if(price >= row.min && price <= row.max){
      const excess = Math.max(0, price - row.min);
      const duty = row.base + (excess / 100) * row.ratePer100;
      return Math.round(duty);
    }
  }
  return 0;
}

/* Helpers */
const $ = id => document.getElementById(id);
const fmt = n => Number(n).toLocaleString('en-AU',{maximumFractionDigits:0});

/* Chart instance holder */
let chartInstance = null;

/* Main calculation */
function updateAll(){
        // Capital appreciation chart logic
        const initialValue = Number(document.getElementById('price').value) || 0;
        const capitalGainRate = Number(document.getElementById('capital_gain').value) / 100 || 0;
        const years = 20;
        let values = [initialValue];
        for(let i=1; i<=years; i++){
          values.push(values[i-1] * (1 + capitalGainRate));
        }
        const valueLabels = Array.from({length: years+1}, (_,i)=>`Year ${i}`);
        drawValueChart({ labels: valueLabels, values });
      /* Property Value Chart Drawing */
      function drawValueChart(data){
        const ctx = document.getElementById('valueChart').getContext('2d');
        if(window.valueChartInstance) window.valueChartInstance.destroy();
        window.valueChartInstance = new Chart(ctx, {
          type: 'line',
          data: {
            labels: data.labels,
            datasets: [{
              label: 'Property Value (AUD)',
              data: data.values,
              borderColor: '#1c7ed6',
              backgroundColor: 'rgba(28,126,214,0.1)',
              fill: true,
              pointRadius: 2
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
              y: { beginAtZero: false, ticks: { callback: value => Intl.NumberFormat('en-AU').format(value) } }
            }
          }
        });
      }
      // Depreciation checkbox logic
      const depreciationCheckbox = document.getElementById('include_depreciation');
      const includeDepreciation = depreciationCheckbox ? depreciationCheckbox.checked : false;
      // ...existing code...
    // Calculate minimum weekly rent for cashflow positive
    const analysis_loan_amount = Number(document.getElementById('out_loan').innerText.replace(/[^\d.]/g, '')) || 0;
    const analysis_interest_rate = Number(document.getElementById('interest_rate').value) / 100;
    const analysis_op_costs = Number(document.getElementById('out_opcosts').innerText.replace(/[^\d.]/g, '')) || 0;
    const analysis_annual_interest = analysis_loan_amount * analysis_interest_rate;
    const analysis_total_annual_expenses = analysis_op_costs + analysis_annual_interest;
    const analysis_min_weekly_rent = Math.ceil(analysis_total_annual_expenses / 52);
    document.getElementById('analysis_text').innerText =
      `To be cashflow positive (cover all expenses), minimum weekly rent required is $${analysis_min_weekly_rent.toLocaleString()}.`;
  // Automatically tick LMI if deposit < 20%
  const deposit_pct_val = Number(document.getElementById('deposit_percent').value) || 20;
  const lmiCheckbox = document.getElementById('include_lmi');
  if(deposit_pct_val < 20) {
    lmiCheckbox.checked = true;
  }
  const price = Number($('price').value) || 0;
  const rent_week = Number($('rent_week').value) || 0;
  const strata_qtr = Number($('strata_qtr').value) || 0;
  const deposit_pct = Number($('deposit_percent').value) || 20;
  const interest_rate = Number($('interest_rate').value) || 6;
  const loan_term = Number($('loan_term').value) || 30;
  const legal = Number($('legal_fee').value) || 0;
  const inspection = Number($('inspection_fee').value) || 0;
  const loan_fees = Number($('loan_fees').value) || 0;
  const include_lmi = $('include_lmi').checked;
  const pm_pct = Number($('pm_pct').value) || 7;
  const maintenance = Number($('maintenance').value) || 1000;

  // deposit
  const deposit_amount = Math.round(price * (deposit_pct/100));
  $('out_deposit').innerText = '$' + fmt(deposit_amount);

  // stamp
  const stamp = calcNSWDuty(price);
  $('out_stamp').innerText = '$' + fmt(stamp);

  // simple LMI estimate if requested & deposit < 20%
  let lmi = 0;
  const loanAmountIf = Math.max(0, price - deposit_amount);
  if(include_lmi && deposit_pct < 20){
    const lvr = loanAmountIf / price;
    // heuristic ramp: between 0.5% - 3% of loan depending on LVR
    const lmiRate = Math.min(0.03, Math.max(0.005, (lvr - 0.8) * 0.5 + 0.01));
    lmi = Math.round(loanAmountIf * lmiRate);
  }
  // Show LMI in summary
  $('out_lmi').innerText = '$' + fmt(lmi);

  const out_fees = legal + inspection + loan_fees + lmi;
  $('out_fees').innerText = '$' + fmt(out_fees);

  const upfront = deposit_amount + stamp + out_fees;
  $('out_upfront').innerText = '$' + fmt(upfront);

  // loan & repayments
  const loan_amount = Math.round(Math.max(0, price - deposit_amount));
  $('out_loan').innerText = '$' + fmt(loan_amount);

  const monthlyRate = interest_rate / 100 / 12;
  const n = loan_term * 12;
  // compute exact monthly repayment, then display rounded
  let monthlyRepayExact = 0;
  if(monthlyRate === 0) monthlyRepayExact = loan_amount / n;
  else monthlyRepayExact = loan_amount * (monthlyRate / (1 - Math.pow(1 + monthlyRate, -n)));
  const monthlyRepay = Math.round(monthlyRepayExact);
  $('out_monthly').innerText = '$' + fmt(monthlyRepay);

  // annuals
  const rentAnnual = Math.round(rent_week * 52);
  $('out_rent_annual').innerText = '$' + fmt(rentAnnual);

  const strataAnnual = Math.round(strata_qtr * 4);
  const council_water = 2200;
  const insurance = 400;
  const pm_fee = Math.round(rentAnnual * (pm_pct/100));
  const opCosts = strataAnnual + council_water + insurance + pm_fee + maintenance;
  $('out_opcosts').innerText = '$' + fmt(opCosts);

  const netBeforeInterest = rentAnnual - opCosts;
  $('out_net_before_interest').innerText = '$' + fmt(netBeforeInterest);

  // compute interest paid in first 12 months using amortisation schedule
  let annualInterest = 0;
  if(monthlyRate === 0){
    annualInterest = 0;
  } else {
    let balance = loan_amount;
    let interestSum = 0;
    for(let m=0;m<12;m++){
      const interestThisMonth = balance * monthlyRate;
      const principalThisMonth = monthlyRepayExact - interestThisMonth;
      balance = Math.max(0, balance - principalThisMonth);
      interestSum += interestThisMonth;
    }
    annualInterest = Math.round(interestSum);
  }
  $('out_interest').innerText = '$' + fmt(annualInterest);

  const netAfterInterest = Math.round(netBeforeInterest - annualInterest);
  $('out_cashflow').innerText = '$' + fmt(Math.abs(netAfterInterest));
  $('out_interest_display').innerText = '$' + fmt(annualInterest);
  
  // Apply color coding to cashflow
  const cashflowEl = $('out_cashflow');
  cashflowEl.classList.remove('positive', 'negative', 'neutral');
  if(netAfterInterest > 0) {
    cashflowEl.classList.add('positive');
    cashflowEl.innerText = '+$' + fmt(netAfterInterest);
  } else if(netAfterInterest < 0) {
    cashflowEl.classList.add('negative');
    cashflowEl.innerText = '-$' + fmt(Math.abs(netAfterInterest));
  } else {
    cashflowEl.classList.add('neutral');
  }

  // yields
  const grossYield = price > 0 ? (rentAnnual / price) * 100 : 0;
  const netYieldBeforeInterest = price > 0 ? (netBeforeInterest / price) * 100 : 0;
  $('out_gross_yield').innerText = grossYield.toFixed(2) + '%';
  $('out_net_yield').innerText = netYieldBeforeInterest.toFixed(2) + '%';

  // draw chart (rent, strata, pm fee, maintenance, interest)
  const chartData = {
    labels: ['Rent', 'Strata', 'Mgmt Fee', 'Maintenance', 'Interest'],
    values: [rentAnnual, strataAnnual, pm_fee, maintenance, annualInterest]
  };
  drawChart(chartData);

  // depreciation & tax
  let depreciation = 0;
  if (includeDepreciation) {
    const buildingValue = Number($('building_value').value) || 0;
    const div43 = Math.round(buildingValue * 0.025);
    const div40 = Number($('div40_annual').value) || 0;
    depreciation = div43 + div40;
  }
  $('out_depreciation').innerText = '$' + fmt(depreciation);

  const taxRate = Number($('taxBracket').value) || 0.30;
  // tax-deductible loss: negative of netAfterInterest (if negative) plus depreciation
  const lossBeforeTax = Math.max(0, -netAfterInterest); // if positive cash, loss is 0
  const totalDeduction = lossBeforeTax + depreciation;
  $('out_total_deduction').innerText = '$' + fmt(totalDeduction);

  const taxRefund = Math.round(totalDeduction * taxRate);
  $('out_tax_refund').innerText = '$' + fmt(taxRefund);

  const afterTaxCashflow = netAfterInterest + taxRefund;
  $('out_after_tax_cashflow').innerText = '$' + fmt(Math.abs(afterTaxCashflow));
  
  // Apply color coding to after-tax cashflow
  const afterTaxEl = $('out_after_tax_cashflow');
  afterTaxEl.classList.remove('positive', 'negative', 'neutral');
  if(afterTaxCashflow > 0) {
    afterTaxEl.classList.add('positive');
    afterTaxEl.innerText = '+$' + fmt(afterTaxCashflow);
  } else if(afterTaxCashflow < 0) {
    afterTaxEl.classList.add('negative');
    afterTaxEl.innerText = '-$' + fmt(Math.abs(afterTaxCashflow));
  } else {
    afterTaxEl.classList.add('neutral');
  }

  // add tax refund into chart as separate dataset (append)
  const chartWithTax = {
    labels: ['Rent', 'Strata', 'Mgmt Fee', 'Maintenance', 'Interest', 'Tax Refund'],
    values: [rentAnnual, strataAnnual, pm_fee, maintenance, annualInterest, taxRefund]
  };
  drawChart(chartWithTax);
}

/* Chart drawing */
function drawChart(data){
  const ctx = document.getElementById('cashflowChart').getContext('2d');
  if(chartInstance) chartInstance.destroy();

  const palette = ['#1c7ed6','#74c0fc','#20c997','#ffd43b','#f03e3e','#6f42c1'];
  chartInstance = new Chart(ctx, {
    type: 'bar',
    data: { labels: data.labels, datasets: [{ label: 'Annual AUD', data: data.values, backgroundColor: palette }] },
    options: { responsive: true, plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } }, scales: { y: { beginAtZero: true, ticks: { callback: value => Intl.NumberFormat('en-AU').format(value) } } } }
  });
}

/* Export PDF */
async function exportPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: 'pt', format: 'a4' });
  const left = 40;
  let y = 40;

  // Title
  doc.setFontSize(16);
  doc.text('Property Investment Summary', left, y);
  y += 20;
  doc.setFontSize(9);
  doc.text(`Generated: ${new Date().toLocaleString()}`, left, y);
  y += 14;

  // Section: Key Inputs
  doc.setFontSize(11);
  doc.setTextColor(30,60,120);
  doc.text('Key Inputs', left, y);
  y += 14;
  doc.setFontSize(10);
  doc.setTextColor(20,50,60);
  const rows = [
    ['Purchase price', $('price').value ? '$' + fmt($('price').value) : '-'],
    ['Weekly rent', $('rent_week').value ? '$' + fmt($('rent_week').value) + ' /wk' : '-'],
    ['Strata (qtr)', $('strata_qtr').value ? '$' + fmt($('strata_qtr').value) + ' /qtr' : '-'],
    ['Deposit (%)', $('deposit_percent').value + '%'],
    ['Interest rate', $('interest_rate').value + '%'],
    ['Loan term', $('loan_term').value + ' yrs'],
    ['Include LMI estimate', $('include_lmi').checked ? 'Yes' : 'No']
  ];
  rows.forEach(r=>{ doc.text(r[0], left, y); doc.text(String(r[1]), 320, y); y += 12; });

  y += 8;
  // Section: Summary Metrics
  doc.setFontSize(11);
  doc.setTextColor(30,60,120);
  doc.text('Summary Metrics', left, y);
  y += 14;
  doc.setFontSize(10);
  doc.setTextColor(20,50,60);
  doc.setFillColor(240,246,255);
  doc.rect(left-6, y-6, 520, 170, 'F');
  let panelY = y;
  const metrics = [
    ['Deposit (cash)', $('out_deposit').innerText],
    ['Stamp duty (NSW)', $('out_stamp').innerText],
    ['Other upfront fees', $('out_fees').innerText],
    ['Total upfront (approx)', $('out_upfront').innerText],
    ['Loan amount', $('out_loan').innerText],
    ['Monthly repayment', $('out_monthly').innerText],
    ['Annual rent', $('out_rent_annual').innerText],
    ['Operating costs (ann)', $('out_opcosts').innerText],
    ['Net before interest (ann)', $('out_net_before_interest').innerText],
    ['Annual interest (est)', $('out_interest').innerText],
    ['Net after interest (ann)', $('out_cashflow').innerText],
    ['Depreciation (ann)', $('out_depreciation').innerText],
    ['Total deduction', $('out_total_deduction').innerText],
    ['Tax refund', $('out_tax_refund').innerText],
    ['After-tax cashflow (ann)', $('out_after_tax_cashflow').innerText]
  ];
  metrics.forEach(m=>{ doc.text(m[0], left, panelY); doc.text(String(m[1]), 320, panelY); panelY += 11; });

  y = panelY + 14;

  // Section: Chart
  doc.setFontSize(11);
  doc.setTextColor(30,60,120);
  doc.text('Cashflow Chart', left, y);
  y += 10;
  try{
    const canvas = document.getElementById('cashflowChart');
    const imgData = canvas.toDataURL('image/png', 1.0);
    const imgWidth = 400; const imgHeight = 160;
    doc.addImage(imgData, 'PNG', left, y, imgWidth, imgHeight);
    y += imgHeight + 18;
  } catch(e){ console.warn('Chart capture failed for PDF:', e); y += 40; }

  // Section: Disclaimer
  doc.setFontSize(9);
  doc.setTextColor(163,51,51);
  const disclaimer = 'Disclaimer: This calculator is for informational purposes only and does not constitute financial advice. Please discuss your personal circumstances with a registered financial advisor before making any investment decisions.';
  const disclaimerLines = doc.splitTextToSize(disclaimer, 500);
  doc.text(disclaimerLines, left, y);

  doc.save('property-summary.pdf');
}

/* Wire up events */
document.getElementById('calcBtn').addEventListener('click', updateAll);
document.getElementById('pdfBtn').addEventListener('click', exportPDF);
document.getElementById('resetBtn').addEventListener('click', ()=>{
  $('price').value = 650000;
  $('rent_week').value = 500;
  $('strata_qtr').value = 1000;
  $('deposit_percent').value = 20;
  $('interest_rate').value = 6.0;
  $('loan_term').value = 30;
  $('legal_fee').value = 1500;
  $('inspection_fee').value = 400;
  $('loan_fees').value = 600;
  $('include_lmi').checked = false;
  $('pm_pct').value = 7;
  $('maintenance').value = 1000;
  updateAll();
});

// auto update on input changes
document.querySelectorAll('input, select').forEach(el => {
  el.addEventListener('change', updateAll);
  el.addEventListener('input', updateAll);
});

/* Initialize */
window.addEventListener('load', ()=>{ 
  updateAll(); 
  
  // Initialize collapsible sections
  document.querySelectorAll('.section-header').forEach(header => {
    const sectionName = header.dataset.section;
    const content = document.getElementById(`section-${sectionName}`);
    
    // Set initial max-height for smooth transitions
    if(content) {
      content.style.maxHeight = content.scrollHeight + 'px';
    }
    
    header.addEventListener('click', () => {
      header.classList.toggle('collapsed');
      if(content) {
        if(header.classList.contains('collapsed')) {
          content.style.maxHeight = '0';
          content.classList.add('collapsed');
        } else {
          content.style.maxHeight = content.scrollHeight + 'px';
          content.classList.remove('collapsed');
        }
      }
    });
  });
});

</script>

</div>
<!-- Capital Appreciation Panel -->
<div class="card" style="margin:32px auto 0 auto;max-width:1200px">
  <h3 style="margin:0 0 16px 0;font-size:18px;color:#0b3b4b">üìà Capital Appreciation Projection</h3>
  <div class="row">
    <div class="col">
      <label>Expected annual capital growth rate (%)</label>
      <input id="capital_gain" type="number" value="3" min="0" max="20" step="0.1" placeholder="3.0" />
      <div class="small">Historical average: 3-5% per year. Adjust based on your market research and property type.</div>
    </div>
  </div>
  <div class="chart-wrap" style="margin-top:18px">
    <div class="chart-title">Projected Property Value Over 20 Years</div>
    <canvas id="valueChart" aria-label="Property value chart"></canvas>
  </div>
  <div class="small" style="margin-top:12px;color:var(--muted)">
    Note: This projection assumes constant growth. Actual property values fluctuate with market conditions.
  </div>
</div>
</body>
</html>
